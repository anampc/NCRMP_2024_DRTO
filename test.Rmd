---
title: "DRTO Field Report"
author: "Nicole Besemer"
date: "7/13/2021"
output:
  word_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Summary

Work under the National Coral Reef Monitoring Plan (NCRMP) was completed in the Dry Tortugas National Park over the course of five days from June 25th through June 29th, 2021. Work was conducting aboard the R/V ANGARI (ANGARI Foundation) and conducted utilizing permits DRTO-2020-SCI-0010 and DRTO-2020-SCI-0011. During these operations, the following deliverables were successfully met:

* Recovery and redeployment (replacement) of all four Subsurface Temperature Recorders (STRs) at the one, five, 15, and 25 meter depths
* Recovery and redeployment (replacement) of all five Calcification Accretion Units (CAUs) and all five Bioerosion Monitoring Units (BMUs), an additional 5 BMUs were installed
*	Collection of 72-hours of Class II discrete water samples via Subsurface Automatic Samplers (SAS) at three hour intervals (total of 22 samples taken â€“ two samples unsuccessfully deployed)
*	Completion of benthic, bioeroder, and parrotfish surveys (Perry Surveys) at all six transect sites
*	Completion of photomosaics at all six survey transect sites
*	Deployment of SeaFET pH logger, Tiltmeter and EcoPAR coinciding with all 72 hours of Class II water sampling data

![Map of STR locations in Dry Tortugas National Park](/Users/LDutra/Desktop/DRTO Travel/DRTO_NCRMPClimate_2021.jpg)



**Personnel**: Nicole Besemer (Chief Scientist), Graham Kolodziej, Nathan Formel, Anderson Mayfield and Patrick Kiel. Total working dives logged: 63

## Prelimanary Data

### Temperature Data

You can also embed plots, for example:

```{r mike STR code, echo=FALSE}
library(lubridate)
library(plotly)
library(scales)
library(ggpubr)
dirList <- c("~/Desktop/DRTO Data Entry/DRTO STRs")

globalMinDate <- globalMaxDate <- NULL
globalMinTemp <- globalMaxTemp <- NULL

# first loop: just determine global axes bounds
for (thisDir in dirList) {
  fileList <- list.files(thisDir)
  processedFiles <- fileList[grep("processed.*\\.csv$", fileList, ignore.case = TRUE)]
  
  for (thisFile in processedFiles) {
    processedData = read.csv(paste(thisDir, thisFile, sep = "/"))
    rows <- nrow(processedData)
    if (rows >= 2) {
      newMinTemp <- min(processedData$Temperature)
      newMaxTemp <- max(processedData$Temperature)
      # remember minimum dates
      if (is.null(globalMinDate)) {
        globalMinDate <- ymd_hms(processedData$UTCDateTime[1])
      } else if (globalMinDate > ymd_hms(processedData$UTCDateTime[1])) {
        globalMinDate <- ymd_hms(processedData$UTCDateTime[1])
      }
      # remember maximum dates
      if (is.null(globalMaxDate)) {
        globalMaxDate <- ymd_hms(processedData$UTCDateTime[rows])
      } else if (globalMaxDate < ymd_hms(processedData$UTCDateTime[rows])) {
        globalMaxDate <- ymd_hms(processedData$UTCDateTime[rows])
      }
      # remember minimum temperatures
      if (is.null(globalMinTemp)) {
        globalMinTemp <- newMinTemp
      } else if (globalMinTemp > newMinTemp) {
        globalMinTemp <- newMinTemp
      }
      # remember maximum temperatures
      if (is.null(globalMaxTemp)) {
        globalMaxTemp <- newMaxTemp
      } else if (globalMaxTemp < newMaxTemp) {
        globalMaxTemp <- newMaxTemp
      }
    }
    # debug: make sure max/min are tracking correctly
    # print(paste("File:", thisFile))
    # print(paste(" this:", ymd_hms(processedData$UTCDateTime[1]), ymd_hms(processedData$UTCDateTime[rows]), newMinTemp, newMaxTemp))
    # print(paste(" glob:", globalMinDate, globalMaxDate, globalMinTemp, globalMaxTemp))
  }
}

# how big should the breaks in the x axis be?
if ((globalMaxDate-globalMinDate) > 365.25) {
  xWidth <- "4 months"
} else {
  xWidth <- "1 month"
}

# second loop: replot data
for (thisDir in dirList) {
  fileList <- list.files(thisDir)
  processedFiles <- fileList[grep("processed.*\\.csv$", fileList, ignore.case = TRUE)]
  
  for (thisFile in processedFiles) {
    plotFile = paste0(sub("processed.*\\.csv$","",thisFile), "labeled.png")
    plotTitle = sub("_[0-9_-]*_processed.*\\.csv$","",thisFile)
    
    # report which plot we're working on
    print(paste("Now processing:", plotTitle))
    
    # read in the data again
    processedData = read.csv(paste(thisDir, thisFile, sep = "/"))
    
    # Hannah's plotting code, adjusted
    plot = ggplot(data = processedData) +
      geom_line(aes(x = ymd_hms(UTCDateTime), y = Temperature), col = 'dodgerblue') +
      theme_bw() +
      theme(plot.margin = unit(c(5.5, 15, 5.5, 5.5), "points")) +
      scale_x_datetime(breaks = breaks_width(xWidth),
                       labels = date_format("%m/%Y"),
                       limits = c(globalMinDate, globalMaxDate)) +
      scale_y_continuous(limits = c(globalMinTemp, globalMaxTemp)) +
      ylab(expression(atop(
        paste("Temperature (", degree, "C)")
      ))) +
      theme(axis.title.x = element_blank())
    
    box = ggplot(data = processedData) +
      geom_boxplot(aes(x = "", y = Temperature), fill = 'dodgerblue') +
      theme_bw() +
      theme(axis.title.x = element_blank(),
            axis.title.y = element_blank())+
      scale_y_continuous(limits = c(globalMinTemp, globalMaxTemp))
    
    comb = ggarrange(plot, box, widths = c(6, 1))
    
    final = annotate_figure(comb, top = plotTitle)
    
    ggsave(
      filename = paste(thisDir, plotFile, sep = "/"),
      plot = final,
      width = 12,
      height = 3
    )
  }
}
```


```{r temperature - individual plot, echo=FALSE,fig.width = 12,fig.height = 3}

str1 <- "~/Desktop/DRTO Data Entry/DRTOSTRs/DRTO_west_01m_sn7774_tag3094_pulaski-shoal_2018-07-11_2021-06-27_processed.csv"
datastr1 <- read.csv(str1, header = TRUE)
ggplot(data = datastr1) +
      geom_line(aes(x = ymd_hms(UTCDateTime), y = Temperature), col = 'dodgerblue') +
      theme_bw() +
      theme(plot.margin = unit(c(5.5, 15, 5.5, 5.5), "points")) +
      scale_x_datetime(breaks = breaks_width(xWidth),
                       labels = date_format("%m/%Y"),
                       limits = c(globalMinDate, globalMaxDate)) +
      scale_y_continuous(limits = c(globalMinTemp, globalMaxTemp)) +
      ylab(expression(atop(
        paste("Temperature (", degree, "C)")
      ))) +
      theme(axis.title.x = element_blank())
    
    box = ggplot(data = processedData) +
      geom_boxplot(aes(x = "", y = Temperature), fill = 'dodgerblue') +
      theme_bw() +
      theme(axis.title.x = element_blank(),
            axis.title.y = element_blank())+
      scale_y_continuous(limits = c(globalMinTemp, globalMaxTemp))
    
    comb = ggarrange(plot, box, widths = c(6, 1))
    
    final = annotate_figure(comb, top = plotTitle)
    
```

```{r tiltmeter data, , echo=FALSE}

library(RColorBrewer)
library(scales)
library(lubridate)
library(openair)
library(magick)
library(ggplot2)

fileAny <- "~/Desktop/DRTO Data Entry/2102061_DRTO-2021-06_(0)_Current.csv"

# hardcoded limits for this DRTO file are
# ymd_hms("2021/06/25 18:30:00") and ymd_hms("2021/06/28 19:45:00")
# (future enhancement: incorporate Hannah Barkley's dataset trimming code;
#  also, eliminate all the hardcoding below and calculate from data)

dataAny <- read.csv(fileAny, header = TRUE)
dataAny$date = ymd_hms(paste0(dataAny$Date, dataAny$Time), tz = "UTC")
dataAny <- dataAny[, c("date","Speed..cm.s.","Heading..degrees.")]
colnames(dataAny) <- c("date","ws","wd")
dataAny$dateEDT<-NA
dataAny <- subset(dataAny, date >= ymd_hms("2021/06/25 18:30:00") & date <= ymd_hms("2021/06/28 19:45:00"))
dataAny$dateEDT <- lubridate::with_tz(dataAny$date, "America/New_York")

# 2021/07/09 working up more tiltmeter graphs completely in R
# (not just openair's windRose plot, which was suggested by Ian originally)

# line plot (Current Speed)
ggplot(data = dataAny) +
  geom_line(aes(x = dateEDT, y = ws), col = 'dodgerblue') +
  theme_bw() +
  theme(plot.margin = unit(c(5.5, 15, 5.5, 5.5), "points")) +
  scale_x_datetime(breaks = date_breaks("8 hours"),
                   labels = date_format("%m/%d\n%H:%M"),
                   limits = c(ymd_hms("2021/06/25 16:00:00"),ymd_hms("2021/06/28 22:00:00")),
                   expand=c(0,0)) +
  ylab(expression(atop("Current Speed (cm/s)"))) +
  xlab(expression(atop("Date and Time (EDT)"))) +
  scale_y_continuous(expand=c(0,0),limits=c(0,12))



```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
